<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>N·∫°p firmware ESP32 - HDN77</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/11.1.0/jsrsasign-all-min.js"></script>
  
  <style>
    /* ... (CSS c·ªßa b·∫°n nh∆∞ c≈©) ... */
    #premium-option { display: none; color: #00d4ff; }
  </style>

  <script type="module">
    import { ESPLoader } from "https://unpkg.com/esptool-js@0.5.4/dist/web/index.js";
    let loader, port;
    window.connect = connect;
    window.flashFirmware = flashFirmware;
    window.verifyCode = verifyCode;

    // 2. D√ÅN N·ªòI DUNG file 'public_key.pem' V√ÄO ƒê√ÇY
    const PUBLIC_KEY_PEM = `
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEArjl+0/xTwxmuLop8heYq
rdlaV5RPDEothugYOqBH14bt8RiS/c2/m0iu3OwnwCFBW0xg5uOxbn8Yol97NQC6
BztYW8GRlO/HntPtgVxCpMCy0LbdFOWabJbs88zCHvm1qPdB8Pt4WtlDgvCDfuO+
9tpo2BzkwaullR0/kE8ltdhg4n/4xbbGFMkkiBoWQu0fQGhb5t6htJRR2R4JwOfC
d6Xga8qSg350Vu/xo/pkPesTB+EbBCPSJXneLgIr8PHIav3ywRCeKLfBZHdtraF8
8JbFkOOPXsszSRSyPDWqrtATtM1Ui6xDAoUZheGWB7SpOR9fZHWKETUZjslR9o4B
qQIDAQAB
-----END PUBLIC KEY-----
`;

    // 3. TH√îNG ƒêI·ªÜP C·ªê ƒê·ªäNH (Ph·∫£i kh·ªõp 100% v·ªõi script Python)
    const MESSAGE_TO_VERIFY = "HDN77_FIRMWARE_PREMIUM_ACCESS";

    // 4. H√ÄM KI·ªÇM TRA CODE (C·∫≠p nh·∫≠t)
    function verifyCode() {
        const codeInput = document.getElementById('premium-code').value.trim();
        const premiumOption = document.getElementById('premium-option');
        const codeStatus = document.getElementById('code-status');

        try {
            // Kh·ªüi t·∫°o ƒë·ªëi t∆∞·ª£ng Signature
            const sig = new jsrsasign.KJUR.crypto.Signature({"alg": "SHA256withRSA"});
            // N·∫°p Kh√≥a C√¥ng khai
            sig.init(PUBLIC_KEY_PEM);
            // N·∫°p th√¥ng ƒëi·ªáp c·∫ßn ki·ªÉm tra
            sig.updateString(MESSAGE_TO_VERIFY);
            
            // Chuy·ªÉn m√£ (Base64) ng∆∞·ªùi d√πng nh·∫≠p sang Hex (th∆∞ vi·ªán y√™u c·∫ßu)
            const keyAsHex = jsrsasign.b64tohex(codeInput);

            // X√°c minh!
            const isValid = sig.verify(keyAsHex);

            if (isValid) {
                premiumOption.style.display = 'block';
                codeStatus.innerText = '‚úÖ ƒê√£ m·ªü kh√≥a Premium! Gi·ªù b·∫°n c√≥ th·ªÉ ch·ªçn.';
                codeStatus.style.color = '#10b981';
            } else {
                throw new Error("Ch·ªØ k√Ω kh√¥ng h·ª£p l·ªá.");
            }
        } catch (e) {
            // N·∫øu m√£ nh·∫≠p v√†o sai ƒë·ªãnh d·∫°ng Base64 ho·∫∑c x√°c minh th·∫•t b·∫°i
            premiumOption.style.display = 'none';
            document.getElementById('radio-premium').checked = false;
            document.getElementById('radio-free').checked = true;
            codeStatus.innerText = '‚ùå M√£ kh√¥ng h·ª£p l·ªá!';
            codeStatus.style.color = '#f59e0b';
            console.error("L·ªói x√°c th·ª±c:", e.message);
        }
    }
    
    // ... (C√°c h√†m connect() v√† flashFirmware() gi·ªØ nguy√™n nh∆∞ c≈©) ...
    async function connect() {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        loader = new ESPLoader(port);
        await loader.initialize();
        document.getElementById("status").innerText = "‚úÖ ƒê√£ k·∫øt n·ªëi ESP32";
      } catch (e) {
        document.getElementById("status").innerText = "‚ùå L·ªói: " + e.message;
      }
    }
    async function flashFirmware() {
      if (!loader) {
        document.getElementById("status").innerText = "‚ùå Vui l√≤ng k·∫øt n·ªëi ESP32 tr∆∞·ªõc.";
        return;
      }
      let firmwarePath;
      if (document.getElementById('radio-free').checked) {
          firmwarePath = "firmware_free.bin";
      } else if (document.getElementById('radio-premium').checked) {
          firmwarePath = "firmware_premium.bin";
      } else {
          document.getElementById("status").innerText = "‚ö†Ô∏è Vui l√≤ng ch·ªçn m·ªôt phi√™n b·∫£n firmware.";
          return;
      }
      try {
        document.getElementById("status").innerText = `‚è≥ ƒêang t·∫£i v√† ghi ${firmwarePath}...`;
        const response = await fetch(firmwarePath);
        if (!response.ok) throw new Error(`Kh√¥ng t√¨m th·∫•y file ${firmwarePath} (${response.status})`);
        const buffer = await response.arrayBuffer();
        const flashOffset = 0x1000;
        await loader.flashData(buffer, flashOffset);
        document.getElementById("status").innerText = "‚úÖ N·∫°p th√†nh c√¥ng!";
      } catch (e) {
        document.getElementById("status").innerText = "‚ùå L·ªói N·∫°p: " + e.message;
      }
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>‚ö° N·∫°p firmware ESP32</h1>
    <p>Nh·∫≠p m√£ Premium ƒë·ªÉ m·ªü kh√≥a:</p>
    <input type="text" id="premium-code" placeholder="Nh·∫≠p m√£ License Key t·∫°i ƒë√¢y">
    <button onclick="verifyCode()" style="background-color: #f59e0b; color: white;">X√°c th·ª±c M√£</button>
    <p id="code-status"></p> 
    <hr style="border: 1px solid #333; margin: 20px 0;">
    <p>Ch·ªçn firmware ƒë·ªÉ n·∫°p:</p>
    <div class="firmware-choice">
      <input type="radio" id="radio-free" name="firmware" value="free" checked>
      <label for="radio-free">‚≠ê FREE (C∆° b·∫£n)</label>
    </div>
    <div class="firmware-choice" id="premium-option">
      <input type="radio" id="radio-premium" name="firmware" value="premium">
      <label for="radio-premium">üíé PREMIUM (Tr·∫£ ph√≠)</label>
    </div>
    <hr style="border: 1px solid #333; margin: 20px 0;">
    <button id="connect" onclick="connect()" style="background-color: #3b82f6; color: white;">üîå K·∫øt n·ªëi thi·∫øt b·ªã</button>
    <button id="flash" onclick="flashFirmware()" style="background-color: #10b981; color: white;">‚¨ÜÔ∏è B·∫Øt ƒë·∫ßu N·∫†P</button>
    <p id="status">Ch∆∞a k·∫øt n·ªëi</p>
    <button class="back-btn" onclick="window.location.href='index.html'">‚Üê Quay l·∫°i trang ch·ªß</button>
  </div>
</body>
</html>